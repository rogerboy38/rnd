{
 "creation": "2025-08-04 19:37:05.483592",
 "docstatus": 0,
 "doctype": "Client Script",
 "dt": "TDS Product Specification",
 "enabled": 1,
 "idx": 0,
 "modified": "2025-08-13 11:05:09.463922",
 "modified_by": "Administrator",
 "module": "RND",
 "name": "TDS Version",
 "owner": "Administrator",
 "script": "frappe.ui.form.on('TDS Product Specification', {\r\n    setup: function(frm) {\r\n        if (frm.doc.__islocal && !frm.doc.tds_sequence) {\r\n            get_next_sequence(frm);\r\n        }\r\n    },\r\n    \r\n    refresh: function(frm) {\r\n        frm.add_custom_button(__('Generate Version'), function() {\r\n            generate_version(frm);\r\n        }, __('Actions')).addClass('btn-primary');\r\n        \r\n        update_preview(frm);\r\n    },\r\n    \r\n    product_item: function(frm) {\r\n        if (frm.doc.product_item) {\r\n            frappe.db.get_value('Item', frm.doc.product_item, 'item_code')\r\n                .then(r => {\r\n                    frm.set_value('item_code', r.message.item_code);\r\n                    if (frm.doc.__islocal) get_next_sequence(frm);\r\n                    update_preview(frm);\r\n                });\r\n        }\r\n    }\r\n});\r\n\r\n// Get next sequence number from TDS Settings\r\nfunction get_next_sequence(frm) {\r\n    if (!frm.doc.item_code) return;\r\n    \r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'TDS Settings',\r\n            filters: { item_code: frm.doc.item_code },\r\n            fields: ['name', 'last_sequence_used']\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                // Existing record found\r\n                const settings = r.message[0];\r\n                const next_seq = (settings.last_sequence_used || 0) + 1;\r\n                frm.set_value('tds_sequence', next_seq);\r\n                update_sequence_in_settings(settings.name, next_seq);\r\n            } else {\r\n                // Create new TDS Settings record\r\n                frappe.call({\r\n                    method: 'frappe.client.insert',\r\n                    args: {\r\n                        doc: {\r\n                            doctype: 'TDS Settings',\r\n                            item_code: frm.doc.item_code,\r\n                            last_sequence_used: 0\r\n                        }\r\n                    },\r\n                    callback: function(r) {\r\n                        frm.set_value('tds_sequence', 1);\r\n                        update_sequence_in_settings(r.message.name, 1);\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Update sequence in TDS Settings\r\nfunction update_sequence_in_settings(name, sequence) {\r\n    frappe.call({\r\n        method: 'frappe.client.set_value',\r\n        args: {\r\n            doctype: 'TDS Settings',\r\n            name: name,\r\n            fieldname: { last_sequence_used: sequence }\r\n        }\r\n    });\r\n}\r\n\r\n// Generate final version number\r\nfunction generate_version(frm) {\r\n    if (!validate_required_fields(frm)) return;\r\n    \r\n    const date_parts = frm.doc.approval_date.split('-');\r\n    const version = `V1.${frm.doc.item_code}-Date:${date_parts[0].slice(-2)}/${date_parts[1]}/${date_parts[2]}*${String(frm.doc.tds_sequence).padStart(4, '0')}`;\r\n    \r\n    frm.set_value('tds_version', version);\r\n    frappe.show_alert(__('Version generated successfully'));\r\n}\r\n\r\n// Validate required fields\r\nfunction validate_required_fields(frm) {\r\n    let valid = true;\r\n    \r\n    if (!frm.doc.item_code) {\r\n        frappe.msgprint(__('Item Code is required'));\r\n        valid = false;\r\n    }\r\n    if (!frm.doc.approval_date) {\r\n        frappe.msgprint(__('Approval Date is required'));\r\n        valid = false;\r\n    }\r\n    if (!frm.doc.tds_sequence) {\r\n        frappe.msgprint(__('Sequence Number is required'));\r\n        valid = false;\r\n    }\r\n    \r\n    return valid;\r\n}\r\n\r\n// Update version preview\r\nfunction update_preview(frm) {\r\n    if (frm.doc.item_code && frm.doc.approval_date && frm.doc.tds_sequence) {\r\n        const date_parts = frm.doc.approval_date.split('-');\r\n        const preview = `Preview: V1.${frm.doc.item_code}-Date:${date_parts[0].slice(-2)}/${date_parts[1]}/${date_parts[2]}*${String(frm.doc.tds_sequence).padStart(4, '0')}`;\r\n        \r\n        if (!frm.fields_dict.version_preview) {\r\n            frm.add_custom_field('version_preview', {\r\n                fieldtype: 'Section Break',\r\n                label: 'Version Preview',\r\n                description: preview\r\n            });\r\n        } else {\r\n            frm.set_df_property('version_preview', 'description', preview);\r\n        }\r\n    }\r\n}\r\nfrappe.ui.form.on('TDS Product Specification', {\r\n    before_workflow_action: function(frm) {\r\n        if (frm.selected_workflow_action === 'Approve' && !frm.doc.approval_date) {\r\n            frappe.call({\r\n                method: 'frappe.utils.nowdate',\r\n                callback: function(r) {\r\n                    frm.set_value('approval_date', r.message);\r\n                }\r\n            });\r\n        }\r\n    }\r\n});",
 "view": "Form"
}
