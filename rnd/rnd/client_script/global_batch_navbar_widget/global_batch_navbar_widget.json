{
 "creation": "2025-08-30 12:33:18.715698",
 "docstatus": 0,
 "doctype": "Client Script",
 "dt": "Batch AMB",
 "enabled": 0,
 "idx": 0,
 "modified": "2025-08-30 13:19:29.676515",
 "modified_by": "fcrm@amb-wellness.com",
 "module": "RND",
 "name": "Global Batch Navbar Widget",
 "owner": "fcrm@amb-wellness.com",
 "script": "// =============================================================================\r\n// BATCH NAVBAR WIDGET - Client-Side JavaScript for Frappe Cloud\r\n// Save this as: public/js/batch_navbar_widget.js\r\n// =============================================================================\r\n\r\n// Use proper Frappe event handling instead of frappe.ready()\r\nfrappe.provide('frappe.ui');\r\n\r\n// Initialize when page loads\r\n$(document).ready(function() {\r\n    initializeBatchWidget();\r\n});\r\n\r\nfunction initializeBatchWidget() {\r\n    // Initialize widget only for logged-in users\r\n    if (frappe.session && frappe.session.user !== 'Guest') {\r\n        console.log('Initializing Batch Navbar Widget...');\r\n        \r\n        // Wait a bit for Frappe to fully initialize\r\n        setTimeout(function() {\r\n            // Set up auto-refresh every 60 seconds\r\n            setInterval(function() {\r\n                update_batch_announcements();\r\n            }, 60000);\r\n            \r\n            // Initial load\r\n            update_batch_announcements();\r\n        }, 3000);\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// MAIN FUNCTIONS\r\n// =============================================================================\r\n\r\nfunction update_batch_announcements() {\r\n    frappe.call({\r\n        method: 'rnd.amb.js.get_running_batch_announcements',\r\n        callback: function(r) {\r\n            if (r.message && r.message.success && r.message.announcements && r.message.announcements.length > 0) {\r\n                display_batch_announcements(r.message.announcements);\r\n            } else {\r\n                // Hide widget if no running batches\r\n                $('.batch-announcement-widget').fadeOut();\r\n            }\r\n        },\r\n        error: function(r) {\r\n            console.error('Error fetching batch announcements:', r);\r\n        }\r\n    });\r\n}\r\n\r\nfunction display_batch_announcements(announcements) {\r\n    let announcement_html = '';\r\n    \r\n    announcements.forEach(function(announcement, index) {\r\n        let priorityColor = announcement.priority === 'high' ? '#00ff00' : '#ffff00';\r\n        \r\n        announcement_html += `\r\n            <div class=\"batch-announcement-item\" style=\"\r\n                margin-bottom: 12px; \r\n                padding: 12px; \r\n                background: #2c3e50; \r\n                color: ${priorityColor}; \r\n                font-family: 'Courier New', monospace; \r\n                border-radius: 6px;\r\n                border-left: 4px solid ${priorityColor};\r\n                position: relative;\r\n            \">\r\n                <div style=\"font-weight: bold; margin-bottom: 8px; font-size: 13px;\">\r\n                    \ud83d\udce2 ${announcement.title || 'Announcement'}\r\n                </div>\r\n                <pre style=\"\r\n                    margin: 0; \r\n                    font-size: 11px; \r\n                    white-space: pre-line; \r\n                    line-height: 1.4;\r\n                    font-family: inherit;\r\n                \">${announcement.content || announcement.message || 'No content'}</pre>\r\n                <div style=\"\r\n                    position: absolute;\r\n                    top: 8px;\r\n                    right: 8px;\r\n                    background: rgba(255,255,255,0.1);\r\n                    padding: 2px 6px;\r\n                    border-radius: 3px;\r\n                    font-size: 9px;\r\n                \">\r\n                    Live\r\n                </div>\r\n            </div>\r\n        `;\r\n    });\r\n    \r\n    if (announcement_html) {\r\n        show_navbar_widget(announcement_html, announcements.length);\r\n    }\r\n}\r\n\r\nfunction show_navbar_widget(html_content, count) {\r\n    // Remove existing widget\r\n    $('.batch-announcement-widget').remove();\r\n    \r\n    // Create floating announcement widget\r\n    let widget = $(`\r\n        <div class=\"batch-announcement-widget\" style=\"\r\n            position: fixed;\r\n            top: 70px;\r\n            right: 20px;\r\n            width: 420px;\r\n            max-height: 600px;\r\n            overflow-y: auto;\r\n            z-index: 1050;\r\n            background: white;\r\n            border: 3px solid #28a745;\r\n            border-radius: 10px;\r\n            box-shadow: 0 6px 20px rgba(0,0,0,0.25);\r\n            padding: 18px;\r\n            animation: slideInRight 0.5s ease-out;\r\n        \">\r\n            <div style=\"\r\n                display: flex; \r\n                justify-content: space-between; \r\n                align-items: center; \r\n                margin-bottom: 15px;\r\n                padding-bottom: 10px;\r\n                border-bottom: 2px solid #28a745;\r\n            \">\r\n                <div>\r\n                    <h4 style=\"margin: 0; color: #28a745; font-size: 16px;\">\r\n                        \ud83c\udfed Producci\u00f3n en Tiempo Real\r\n                    </h4>\r\n                    <small style=\"color: #666; font-size: 11px;\">\r\n                        ${count} lote${count !== 1 ? 's' : ''} activo${count !== 1 ? 's' : ''}\r\n                    </small>\r\n                </div>\r\n                <div>\r\n                    <button class=\"btn btn-xs btn-success refresh-announcements\" style=\"margin-right: 5px;\" title=\"Actualizar\">\r\n                        \ud83d\udd04\r\n                    </button>\r\n                    <button class=\"btn btn-xs btn-secondary minimize-announcement\" title=\"Minimizar\">\r\n                        \ud83d\udccc\r\n                    </button>\r\n                    <button class=\"btn btn-xs btn-secondary close-announcement\" title=\"Cerrar\">\r\n                        \u2715\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            <div class=\"announcement-content\">\r\n                ${html_content}\r\n            </div>\r\n            <div style=\"\r\n                text-align: center; \r\n                margin-top: 15px; \r\n                padding-top: 10px;\r\n                border-top: 1px solid #eee;\r\n                font-size: 10px; \r\n                color: #666;\r\n            \">\r\n                \ud83d\udd04 Actualizaci\u00f3n autom\u00e1tica cada minuto \u2022 \r\n                <span id=\"last-update-time\">${new Date().toLocaleTimeString('es-ES')}</span>\r\n            </div>\r\n        </div>\r\n    `);\r\n    \r\n    // Add to page\r\n    $('body').append(widget);\r\n    \r\n    // Event handlers\r\n    setup_widget_events(widget);\r\n    \r\n    // Auto-minimize after 45 seconds\r\n    setTimeout(function() {\r\n        if (widget.is(':visible')) {\r\n            widget.css({\r\n                'opacity': '0.8',\r\n                'transform': 'scale(0.95)'\r\n            });\r\n        }\r\n    }, 45000);\r\n}\r\n\r\n// =============================================================================\r\n// EVENT HANDLERS\r\n// =============================================================================\r\n\r\nfunction setup_widget_events(widget) {\r\n    // Refresh button\r\n    widget.find('.refresh-announcements').off('click').on('click', function() {\r\n        var $this = $(this);\r\n        $this.html('\u23f3');\r\n        update_batch_announcements();\r\n        setTimeout(function() {\r\n            $this.html('\ud83d\udd04');\r\n        }, 1000);\r\n    });\r\n    \r\n    // Minimize button\r\n    widget.find('.minimize-announcement').off('click').on('click', function() {\r\n        var $this = $(this);\r\n        widget.animate({\r\n            width: '60px',\r\n            height: '50px'\r\n        }, 300);\r\n        widget.find('.announcement-content, h4, small, .close-announcement, .refresh-announcements').hide();\r\n        $this.text('\ud83d\udccb').attr('title', 'Expandir');\r\n        \r\n        // Click to expand\r\n        $this.off('click').on('click', function() {\r\n            widget.animate({\r\n                width: '420px',\r\n                height: 'auto'\r\n            }, 300);\r\n            widget.find('.announcement-content, h4, small, .close-announcement, .refresh-announcements').show();\r\n            $this.text('\ud83d\udccc').attr('title', 'Minimizar');\r\n            setup_widget_events(widget);\r\n        });\r\n    });\r\n    \r\n    // Close button\r\n    widget.find('.close-announcement').off('click').on('click', function() {\r\n        widget.fadeOut(300, function() {\r\n            $(this).remove();\r\n        });\r\n        \r\n        // Re-show after 5 minutes\r\n        setTimeout(function() {\r\n            update_batch_announcements();\r\n        }, 300000);\r\n    });\r\n    \r\n    // Hover effects\r\n    widget.off('mouseenter mouseleave').hover(\r\n        function() {\r\n            $(this).css({\r\n                'opacity': '1',\r\n                'transform': 'scale(1)',\r\n                'box-shadow': '0 8px 25px rgba(0,0,0,0.3)'\r\n            });\r\n        },\r\n        function() {\r\n            $(this).css({\r\n                'opacity': '0.95',\r\n                'transform': 'scale(1)',\r\n                'box-shadow': '0 6px 20px rgba(0,0,0,0.25)'\r\n            });\r\n        }\r\n    );\r\n}\r\n\r\n// =============================================================================\r\n// CSS ANIMATIONS\r\n// =============================================================================\r\n\r\n// Add CSS animations only once\r\nif (typeof window.batchWidgetStylesAdded === 'undefined') {\r\n    window.batchWidgetStylesAdded = true;\r\n    \r\n    var styles = `\r\n        <style id=\"batch-widget-styles\">\r\n            @keyframes slideInRight {\r\n                from {\r\n                    transform: translateX(100%);\r\n                    opacity: 0;\r\n                }\r\n                to {\r\n                    transform: translateX(0);\r\n                    opacity: 1;\r\n                }\r\n            }\r\n            \r\n            .batch-announcement-widget {\r\n                transition: all 0.3s ease;\r\n            }\r\n            \r\n            .batch-announcement-item {\r\n                transition: all 0.2s ease;\r\n            }\r\n            \r\n            .batch-announcement-item:hover {\r\n                transform: translateX(-3px);\r\n                box-shadow: 0 3px 10px rgba(0,0,0,0.2);\r\n            }\r\n            \r\n            @media (max-width: 768px) {\r\n                .batch-announcement-widget {\r\n                    width: calc(100vw - 40px) !important;\r\n                    right: 20px !important;\r\n                    font-size: 12px !important;\r\n                }\r\n            }\r\n        </style>\r\n    `;\r\n    \r\n    $('head').append(styles);\r\n}\r\n\r\n// =============================================================================\r\n// GLOBAL FUNCTIONS\r\n// =============================================================================\r\n\r\n// Make functions available globally\r\nwindow.refresh_batch_announcements = update_batch_announcements;\r\nwindow.hide_batch_widget = function() {\r\n    $('.batch-announcement-widget').fadeOut();\r\n};\r\nwindow.show_batch_widget = function() {\r\n    update_batch_announcements();\r\n};\r\n\r\n// Export for potential use in other scripts\r\nif (typeof module !== 'undefined' && module.exports) {\r\n    module.exports = {\r\n        update_batch_announcements: update_batch_announcements,\r\n        hide_batch_widget: hide_batch_widget,\r\n        show_batch_widget: show_batch_widget\r\n    };\r\n}",
 "view": "Form"
}
