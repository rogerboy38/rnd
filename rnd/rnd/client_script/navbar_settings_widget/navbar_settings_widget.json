{
 "creation": "2025-08-31 00:37:50.772917",
 "docstatus": 0,
 "doctype": "Client Script",
 "dt": "Navbar Settings",
 "enabled": 0,
 "idx": 0,
 "modified": "2025-08-31 00:40:28.076904",
 "modified_by": "fcrm@amb-wellness.com",
 "module": "RND",
 "name": "Navbar Settings Widget",
 "owner": "fcrm@amb-wellness.com",
 "script": "// =============================================================================\r\n// BATCH NAVBAR WIDGET - Custom Script for Navbar Settings\r\n// =============================================================================\r\n\r\nfrappe.ui.form.on('Navbar Settings', {\r\n    refresh: function(frm) {\r\n        // Initialize the batch widget when Navbar Settings form loads\r\n        initializeBatchWidget();\r\n    }\r\n});\r\n\r\n// =============================================================================\r\n// BATCH WIDGET FUNCTIONS\r\n// =============================================================================\r\n\r\nfunction initializeBatchWidget() {\r\n    // Wait for Frappe to be fully loaded and user to be logged in\r\n    if (typeof frappe === 'undefined' || !frappe.session || frappe.session.user === 'Guest') {\r\n        setTimeout(initializeBatchWidget, 1000);\r\n        return;\r\n    }\r\n\r\n    console.log('\ud83d\ude80 Initializing Batch Navbar Widget for user:', frappe.session.user);\r\n    addWidgetStyles();\r\n    \r\n    // Set up auto-refresh every 30 seconds\r\n    setInterval(update_batch_announcements, 30000);\r\n    \r\n    // Initial load after 2 seconds\r\n    setTimeout(update_batch_announcements, 2000);\r\n}\r\n\r\nfunction update_batch_announcements() {\r\n    console.log('\ud83d\udd04 Fetching Batch AMB data...');\r\n    \r\n    frappe.call({\r\n        method: 'frappe.client.get_list',\r\n        args: {\r\n            doctype: 'Batch AMB',\r\n            fields: ['name', 'title', 'wo_start_date', 'status', 'custom_batch_level'],\r\n            filters: { 'status': ['!=', 'Completed'] },\r\n            limit: 10\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.length > 0) {\r\n                console.log('\u2705 Found', r.message.length, 'active batches');\r\n                process_batch_data(r.message);\r\n            } else {\r\n                console.log('\u2139\ufe0f No active batches found');\r\n                show_no_batches_message();\r\n            }\r\n        },\r\n        error: function(r) {\r\n            console.log('\u26a0\ufe0f No batches found or connection issue');\r\n            show_no_batches_message();\r\n        }\r\n    });\r\n}\r\n\r\nfunction process_batch_data(batches) {\r\n    const announcements = batches.map(batch => {\r\n        return {\r\n            id: batch.name,\r\n            title: batch.title || batch.name,\r\n            start_date: batch.wo_start_date,\r\n            status: batch.status || 'Active',\r\n            level: batch.custom_batch_level || '1'\r\n        };\r\n    });\r\n    \r\n    display_batch_announcements(announcements);\r\n}\r\n\r\nfunction display_batch_announcements(announcements) {\r\n    let announcement_html = '';\r\n    \r\n    announcements.forEach(function(announcement, index) {\r\n        const levelColors = {'1': '#e74c3c', '2': '#3498db', '3': '#2ecc71', '4': '#f39c12'};\r\n        const color = levelColors[announcement.level] || '#95a5a6';\r\n        \r\n        announcement_html += `\r\n            <div class=\"batch-announcement-item\" data-batch-id=\"${announcement.id}\" \r\n                 style=\"margin-bottom: 12px; padding: 12px; background: white; \r\n                        color: #333; border-radius: 8px; border-left: 4px solid ${color};\r\n                        position: relative; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\r\n                        transition: all 0.3s ease;\">\r\n                \r\n                <div style=\"font-weight: bold; margin-bottom: 8px; font-size: 14px;\">\r\n                    \ud83c\udfed ${announcement.title}\r\n                </div>\r\n                \r\n                <div style=\"font-size: 11px; color: #555;\">\r\n                    \ud83d\udd22 ID: ${announcement.id}\r\n                </div>\r\n                \r\n                <div style=\"font-size: 11px; color: #555; margin-top: 4px;\">\r\n                    \ud83d\udcca Nivel: ${announcement.level} \u2022 Estado: ${announcement.status}\r\n                </div>\r\n                \r\n                ${announcement.start_date ? `\r\n                <div style=\"font-size: 11px; color: #555; margin-top: 4px;\">\r\n                    \ud83d\udcc5 Inicio: ${frappe.datetime.str_to_user(announcement.start_date)}\r\n                </div>\r\n                ` : ''}\r\n                \r\n                <div style=\"display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 10px; color: #888;\">\r\n                    <span>${new Date().toLocaleTimeString('es-ES')}</span>\r\n                    <span style=\"background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold;\">\r\n                        ACTIVO\r\n                    </span>\r\n                </div>\r\n            </div>\r\n        `;\r\n    });\r\n    \r\n    show_navbar_widget(announcement_html, announcements.length);\r\n}\r\n\r\nfunction show_navbar_widget(html_content, count) {\r\n    // Remove existing widget if any\r\n    $('.batch-announcement-widget').remove();\r\n    \r\n    const timestamp = new Date().toLocaleTimeString('es-ES');\r\n\r\n    let widget = $(`\r\n        <div class=\"batch-announcement-widget\" style=\"position: fixed; top: 70px; right: 20px; width: 400px; max-height: 70vh; overflow-y: auto; \r\n            z-index: 9999; background: white; color: #333; border: 2px solid #28a745; \r\n            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 20px;\r\n            animation: slideInRight 0.5s ease-out;\">\r\n            \r\n            <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #eee;\">\r\n                <div>\r\n                    <h4 style=\"margin: 0; color: #28a745; font-size: 18px; font-weight: 600;\">\r\n                        \ud83c\udfed MONITOR BATCH AMB\r\n                    </h4>\r\n                    <small style=\"color: #666; font-size: 12px;\">\r\n                        ${count} lote${count !== 1 ? 's' : ''} activo${count !== 1 ? 's' : ''} \u2022 Actualizado: ${timestamp}\r\n                    </small>\r\n                </div>\r\n                <div style=\"display: flex; gap: 6px;\">\r\n                    <button class=\"refresh-announcements\" style=\"background: #28a745; border: 1px solid #28a745; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;\">\r\n                        \ud83d\udd04\r\n                    </button>\r\n                    <button class=\"close-announcement\" style=\"background: #dc3545; border: 1px solid #dc3545; color: white; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;\">\r\n                        \u2715\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            \r\n            <div class=\"announcement-content\" style=\"max-height: 400px; overflow-y: auto; padding-right: 5px;\">\r\n                ${html_content || '<div style=\"text-align: center; padding: 20px; color: #666;\">No hay lotes activos en este momento</div>'}\r\n            </div>\r\n            \r\n            <div style=\"text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 11px; color: #888;\">\r\n                \ud83d\udd04 Actualizaci\u00f3n autom\u00e1tica cada 30s\r\n            </div>\r\n        </div>\r\n    `);\r\n    \r\n    $('body').append(widget);\r\n    \r\n    // Add event handlers\r\n    widget.find('.refresh-announcements').click(function() {\r\n        const $btn = $(this);\r\n        $btn.html('\u23f3').prop('disabled', true);\r\n        update_batch_announcements();\r\n        setTimeout(() => {\r\n            $btn.html('\ud83d\udd04').prop('disabled', false);\r\n        }, 1500);\r\n    });\r\n    \r\n    widget.find('.close-announcement').click(function() {\r\n        widget.fadeOut(300, function() {\r\n            $(this).remove();\r\n        });\r\n    });\r\n    \r\n    widget.find('.batch-announcement-item').click(function() {\r\n        const batchId = $(this).data('batch-id');\r\n        frappe.set_route('Form', 'Batch AMB', batchId);\r\n    });\r\n}\r\n\r\nfunction show_no_batches_message() {\r\n    const message = `\r\n        <div style=\"text-align: center; padding: 40px 20px; color: #666;\">\r\n            <div style=\"font-size: 48px; margin-bottom: 15px;\">\ud83d\udccb</div>\r\n            <h4 style=\"color: #666; margin-bottom: 10px; font-weight: normal;\">No hay lotes activos</h4>\r\n            <p style=\"font-size: 12px; opacity: 0.7;\">Todos los batches est\u00e1n completos o en pausa</p>\r\n            <div style=\"margin-top: 15px;\">\r\n                <button onclick=\"frappe.set_route('List', 'Batch AMB', 'List')\" \r\n                        style=\"background: #f8f9fa; border: 1px solid #dee2e6; color: #495057; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;\">\r\n                    \ud83d\udccb Ver todos los batches\r\n                </button>\r\n            </div>\r\n        </div>\r\n    `;\r\n    show_navbar_widget(message, 0);\r\n}\r\n\r\nfunction addWidgetStyles() {\r\n    if ($('#batch-widget-styles').length) return;\r\n    \r\n    const styles = `\r\n        <style id=\"batch-widget-styles\">\r\n            @keyframes slideInRight {\r\n                from {\r\n                    transform: translateX(100%);\r\n                    opacity: 0;\r\n                }\r\n                to {\r\n                    transform: translateX(0);\r\n                    opacity: 1;\r\n                }\r\n            }\r\n            \r\n            .batch-announcement-widget {\r\n                transition: all 0.3s ease;\r\n            }\r\n            \r\n            .batch-announcement-item {\r\n                transition: all 0.3s ease;\r\n            }\r\n            \r\n            .batch-announcement-item:hover {\r\n                transform: translateX(-4px);\r\n                box-shadow: 0 4px 15px rgba(0,0,0,0.15);\r\n            }\r\n            \r\n            .refresh-announcements:hover {\r\n                background: #218838 !important;\r\n                border-color: #1e7e34 !important;\r\n            }\r\n            \r\n            .close-announcement:hover {\r\n                background: #c82333 !important;\r\n                border-color: #bd2130 !important;\r\n            }\r\n            \r\n            @media (max-width: 768px) {\r\n                .batch-announcement-widget {\r\n                    width: calc(100vw - 40px) !important;\r\n                    right: 20px !important;\r\n                    left: 20px !important;\r\n                    top: 80px !important;\r\n                    font-size: 14px !important;\r\n                }\r\n            }\r\n        </style>\r\n    `;\r\n    \r\n    $('head').append(styles);\r\n}\r\n\r\n// Global functions for manual control\r\nwindow.BatchWidget = {\r\n    refresh: update_batch_announcements,\r\n    hide: function() {\r\n        $('.batch-announcement-widget').fadeOut(300, function() {\r\n            $(this).remove();\r\n        });\r\n    },\r\n    show: function() {\r\n        update_batch_announcements();\r\n    }\r\n};\r\n\r\nconsole.log('\u2705 Batch AMB Navbar Widget loaded successfully');",
 "view": "Form"
}
